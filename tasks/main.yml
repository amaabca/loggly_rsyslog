---
- name: Add Nginx Rsyslog configuration file
  template: src="{{ item }}" dest="/etc/rsyslog.d/{{ item }}" owner=root group=root
  with_items:
    - 21-nginx-loggly.conf
    - 21-rails.conf
    - 22-loggly.conf

- name: Create cerfiticates folder If It Does Not Exist
  file: path=/etc/rsyslog.d/keys/ca.d state=directory

- name: Get Certificates From Loggly
  command: curl -O https://logdog.loggly.com/media/loggly.com.crt
  args:
    chdir: /etc/rsyslog.d/keys/ca.d

- name: Get Bundled Cert
  command: curl -O https://certs.secureserver.net/repository/sf_bundle.crt
  args:
    chdir: /etc/rsyslog.d/keys/ca.d

- name: Concatenate Certs together
  shell: cat {sf_bundle.crt,loggly.com.crt} > loggly_full.crt
  args:
    chdir: /etc/rsyslog.d/keys/ca.d
  notify:
    - restart rsyslog
  tags: rsyslog

- name: Check that rsyslog is running
  service: name=rsyslog state=running enabled=yes
  tags: rsyslog
